name: Build

on: [push, pull_request]

jobs:
  dist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: hynek/build-and-inspect-python-package@v2

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          format: 'cyclonedx-json'
          output-file: 'sbom.cyclonedx.json'

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: hynek/setup-cached-uv@v2

      - run: uv run pytest

  attest:
    needs: [dist]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      attestations: write

    steps:
      - uses: actions/download-artifact@v5
        with:
          name: Packages
          path: dist
      - uses: actions/download-artifact@v5
        with:
          name: badge-groups-dist.cyclonedx.json

      - name: Attest
        uses: actions/attest-sbom@v3
        id: attest
        with:
          subject-path: dist/*
          sbom-path: 'badge-groups-dist.cyclonedx.json'

      - uses: actions/attest-build-provenance@v3
        with:
          subject-path: "dist/*"
